name: TBMM Kanun Teklifleri Scraper

on:
  # Her gÃ¼n saat 09:00 UTC'de Ã§alÄ±ÅŸÄ±r (TÃ¼rkiye saati 12:00)
  schedule:
    - cron: '0 9 * * *'
  
  # Manuel tetikleme iÃ§in
  workflow_dispatch:
  
  # Push olduÄŸunda test iÃ§in Ã§alÄ±ÅŸsÄ±n
  push:
    branches:
      - master
    paths:
      - 'scraper/kanun_teklifleri_scraper.py'
      - '.github/workflows/scrape-kanun-teklifleri.yml'

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # SonuÃ§larÄ± commit edebilmek iÃ§in
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ Python kurulumu
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Python baÄŸÄ±mlÄ±lÄ±klarÄ±nÄ± yÃ¼kle
        run: |
          cd scraper
          pip install -r requirements.txt
      
      - name: ğŸŒ Chrome ve ChromeDriver kurulumu
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
      
      - name: âœ… Chrome versiyonunu kontrol et
        run: |
          google-chrome --version
          chromedriver --version
      
      - name: ğŸš€ Scraper'Ä± Ã§alÄ±ÅŸtÄ±r
        run: |
          cd scraper
          python kanun_teklifleri_scraper.py
        env:
          # Headless mode iÃ§in
          DISPLAY: ':99'
      
      - name: ğŸ“Š Ã‡ekilen veri istatistikleri
        run: |
          if [ -f scraper/data/kanun_teklifleri_sorgu.json ]; then
            echo "âœ… Veri baÅŸarÄ±yla Ã§ekildi"
            echo "ğŸ“ Dosya boyutu: $(du -h scraper/data/kanun_teklifleri_sorgu.json | cut -f1)"
            echo "ğŸ“‹ Toplam kayÄ±t sayÄ±sÄ±: $(cat scraper/data/kanun_teklifleri_sorgu.json | python -c 'import json, sys; print(len(json.load(sys.stdin)))' 2>/dev/null || echo 'hesaplanamadÄ±')"
          else
            echo "âŒ Veri dosyasÄ± oluÅŸturulamadÄ±"
            exit 1
          fi
      
      - name: ğŸ’¾ DeÄŸiÅŸiklikleri commit et
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add scraper/data/kanun_teklifleri_sorgu.json
          
          # EÄŸer deÄŸiÅŸiklik varsa commit et
          if git diff --staged --quiet; then
            echo "â„¹ï¸ Yeni deÄŸiÅŸiklik yok, commit atlanÄ±yor"
          else
            git commit -m "ğŸ¤– Otomatik veri gÃ¼ncelleme: $(date +'%Y-%m-%d %H:%M')"
            git push
            echo "âœ… Veriler baÅŸarÄ±yla commit edildi ve push yapÄ±ldÄ±"
          fi
      
      - name: ğŸ“¤ PHP API'ye veri gÃ¶nder
        if: success()
        env:
          API_ENDPOINT: ${{ secrets.API_ENDPOINT }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          if [ -z "$API_ENDPOINT" ] || [ -z "$API_KEY" ]; then
            echo "âš ï¸ API_ENDPOINT veya API_KEY tanÄ±mlanmamÄ±ÅŸ, API Ã§aÄŸrÄ±sÄ± atlanÄ±yor"
            echo "â„¹ï¸ GitHub Secrets'ta API_ENDPOINT ve API_KEY tanÄ±mlayÄ±n"
            exit 0
          fi
          
          echo "ğŸŒ PHP API'ye veri gÃ¶nderiliyor..."
          echo "ğŸ“ Endpoint: $API_ENDPOINT"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "$API_ENDPOINT" \
            -H "Content-Type: application/json" \
            -H "X-API-KEY: $API_KEY" \
            -d @scraper/data/kanun_teklifleri_sorgu.json)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          echo "ğŸ“Š HTTP Status: $HTTP_CODE"
          echo "ğŸ“„ Response: $BODY"
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Veri baÅŸarÄ±yla PHP API'ye gÃ¶nderildi!"
          else
            echo "âŒ API Ã§aÄŸrÄ±sÄ± baÅŸarÄ±sÄ±z oldu!"
            echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
            exit 1
          fi
      
      - name: ğŸ“¤ Artifact olarak kaydet (yedek)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: kanun-teklifleri-data-${{ github.run_number }}
          path: scraper/data/kanun_teklifleri_sorgu.json
          retention-days: 30
      
      - name: ğŸ”” Hata durumunda bildirim (opsiyonel)
        if: failure()
        run: |
          echo "âŒ Scraping veya API gÃ¶nderimi baÅŸarÄ±sÄ±z oldu!"
          echo "ğŸ”— Workflow Ã§alÄ±ÅŸmasÄ±nÄ± kontrol edin: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

